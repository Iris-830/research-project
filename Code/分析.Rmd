```{r}
# --------------------------------------------------------
# clear the environment var area
rm(list = ls())
# clear all plots
graphics.off()
# clear the console area
cat("\014")
```

1.  Analyzing the Social Determinants of Fistula

    1.1 Data Preprocessing

```{r}
# --------------------------------------------------------
library(haven)
library(dplyr)
# read sav file
data.origin = read_sav('/Users/qimiao/Desktop/7.28/Data.sav')

# --------------------------------------------------------
# Delete missing values in target rows

data_clean <- data.origin %>% filter(!is.na(experienced_fistula))

# --------------------------------------------------------
# Cross-analysis using xtabs
cross_tab <- xtabs(~ country + experienced_fistula, data = data_clean)
print(cross_tab)

# If fewer than 50 people answered "Yes" to experienced_fistula for a particular country, the data may not be statistically representative and may not provide enough information for reliable analysis.
# Therefore, removing these countries.

# Removing BurkinaFaso, Gambia and Niger
data_clean <- data_clean %>%
  filter(!(country %in% c("BurkinaFaso", "Gambia", "Niger")))

# --------------------------------------------------------
#See the missing value
library(naniar)
gg_miss_var(data_clean)

# --------------------------------------------------------
# Selecting specific variables
selected_columns <- c(
  "experienced_fistula",
  "country",
  "V005",
  "age",
  "distance",
  "age_sex",
  "number_birth",
  "religion",
  "residence",
  "wealth",
  "education",
  "occupation",
  "contraception_use",
  "delivery_place",
  "delivery_professional",
  "postpartum_care"
)

# Create a new data frame
data_selected <- data_clean[, selected_columns]

# Delete rows with missing values
data1 <- na.omit(data_selected)

# View the dataset
head(data1)

# View the structure of the dataset
str(data1)

```

1.2 Descriptive Statistical Analysis

```{r}
# --------------------------------------------------------
# Processing weight
library(survey)

# DHS weights need to be divided by 1,000,000
data_design <- data1 %>% mutate(weight = V005 / 1000000)  
dhs_design <- svydesign(id = ~1, weights = ~weight, data = data_design)

# 保存为CSV文件
#write.csv(data_design, file = "data_design.csv", row.names = FALSE)


# --------------------------------------------------------
# Descriptive Statistical Analysis
# Convert variable types
dhs_design$variables <- dhs_design$variables %>%
  mutate(across(where(is.labelled), as.numeric))

# Descriptive statistical analysis
summary_statistics <- function(dhs_design, variable) {
  formula <- as.formula(paste("~", variable))
  mean <- svymean(formula, dhs_design, na.rm = TRUE)
  var <- svyvar(formula, dhs_design, na.rm = TRUE)
  quantiles <- svyquantile(formula, dhs_design, c(0.25, 0.5, 0.75), na.rm = TRUE)
  sd <- sqrt(coef(var))
  
  data.frame(
    mean = coef(mean)[1],
    se = SE(mean)[1],
    median = coef(quantiles)[2],
    q1 = coef(quantiles)[1],
    q3 = coef(quantiles)[3],
    sd = sd,
    min = min(dhs_design$variables[[variable]], na.rm = TRUE),
    max = max(dhs_design$variables[[variable]], na.rm = TRUE)
  )
}

# Calculate descriptive statistics
variables <- c("experienced_fistula", "age", "age_sex", "number_birth", "religion", 
               "residence", "wealth", "education", "occupation", 
               "contraception_use", "delivery_place", "distance",
               "delivery_professional", "postpartum_care")

summary_list <- lapply(variables, function(var) {
  summary_statistics(dhs_design, var)})

summary_df <- bind_rows(summary_list) %>%
  select(mean, se, median, q1, q3, sd, min, max)

print(summary_df)

# --------------------------------------------------------
# write.csv(summary_df, "summary_statistics.csv")

```

结论：

整体患病率：西非整体的瘘患病率为1.2%，这表明瘘在该地区是一个重要的公共卫生问题。

**年龄**：接受调查的西非女性年龄大多数在20-39岁之间。

age_sex：平均值为1.136。这说明西非地区女性初次性行为的年龄普遍较早，主要集中在8-19岁之间。

**生育数量：平均值**0.461。表明大多数女性的生育数量在3个以下，这反映了该地区女性的整体生育情况。

**教育水平**：教育水平平均值为0.721，且中位数为0，表示多数人群介于“无教育”和“初级教育”之间，且接近于“初级教育”。这意味着大多数女性受教育程度较低。

**财富分布**：财富水平的平均值为2.827，表示多数人群介于“较贫困”和“中等”之间。另外西非的财富水平分布较广，存在财富不平等的问题。

**宗教信仰**：**均值**为1.338，表明大多数受调查者信仰“Muslim”，其次信仰“基督教”，反映了西非地区主要的宗教信仰分布。**标准差**为0.599，表示宗教信仰在受调查者中有一定的多样性。

**居住地**：均值为1.652，中位数为2，表示大多数受调查者居住在农村地区。

**职业类型**：平均值为0.901，表示大部分处于工作中的状态。

**避孕方法**：平均值为1.880，表明受调查者大部分没有使用避孕方法。同时，也说明西非地区的避孕方法多样，以及现代避孕方法的使用率相对较低。

Delivery Place：平均值为2.200，且中位数和Q3均为3，这表明多数女性在医疗设施内分娩。

### **Postpartum Care：**平均值为2.485，数据集中在3，这表明大多数女性都没有接受产后护理。

delivery professional：**平均值**为1.313，大多数女性在分娩时能够获得专业助产，但仍有部分女性未能获得持续的专业帮助。

distance：**平均值**为0.381，表示样本中的大多数女性认为求医距离并不远。

```{r}
# --------------------------------------------------------
# Compute descriptive statistics by country group
summary_by_country <- function(dhs_design, variable) {
  formula <- as.formula(paste("~", variable))
  country_summary <- svyby(formula, ~country, dhs_design, svymean, na.rm = TRUE)
  country_quantiles <- svyby(formula, ~country, dhs_design, svyquantile, quantiles = c(0.25, 0.5, 0.75), na.rm = TRUE)
  country_var <- svyby(formula, ~country, dhs_design, svyvar, na.rm = TRUE)
  country_sd <- sqrt(country_var[, -1])
  
  data.frame(
    country = country_summary$country,
    variable = variable,
    mean = country_summary[, 2],
    se = country_summary[, 3],
    median = country_quantiles[, 3],
    q1 = country_quantiles[, 2],
    q3 = country_quantiles[, 4],
    sd = country_sd[, 2], # Assuming the second column is the SD for the variable
    min = tapply(dhs_design$variables[[variable]], dhs_design$variables$country, min, na.rm = TRUE),
    max = tapply(dhs_design$variables[[variable]], dhs_design$variables$country, max, na.rm = TRUE)
  )
}

# Descriptive statistics are calculated for each variable grouped by country
summary_by_country_list <- lapply(variables, function(var) {
  summary_by_country(dhs_design, var)
})

country_tables <- summary_by_country_list %>%
  bind_rows() %>%
  group_by(country) %>%
  group_split()

# Printing results
for (country_df in country_tables) {
  country_name <- unique(country_df$country)
  print(country_df)
}

# --------------------------------------------------------
# Combine all summaries into one dataframe
combined_summary_df <- bind_rows(summary_by_country_list)

# Save the combined dataframe to a CSV file
# write.csv(combined_summary_df, "all_country_statistics.csv", row.names = FALSE)


```

```{r}
# --------------------------------------------------------
# Actual Prevalence

# West Africa
prevalence_A <- svymean(~experienced_fistula, dhs_design)
print(prevalence_A)

```

Overall prevalence:

The overall fistula prevalence in West Africa is 1.25%.

This indicates that fistula is a significant public health problem in the region.

```{r}
# --------------------------------------------------------
# Calculate the prevalence of different variables for West Africa
calculate_prevalence <- function(dhs_design, variable) {
  svyby(~experienced_fistula, as.formula(paste("~", variable)), dhs_design, svymean)
}

variables <- c("country", "distance", "age_sex", "number_birth", "religion", 
               "residence", "wealth", "education", "occupation", 
               "contraception_use", "delivery_place", "age",
               "delivery_professional", "postpartum_care")

prevalence_list <- lapply(variables, function(var) calculate_prevalence(dhs_design, var))

names(prevalence_list) <- variables

# Print grouped prevalence
for (var in names(prevalence_list)) {
  print(prevalence_list[[var]])}

# --------------------------------------------------------
# Save to separate CSV files
#for (var in names(prevalence_list)) {
#  df <- prevalence_list[[var]]
#  filename <- paste0(var, "_prevalence_data.csv")
#  write.csv(df, filename, row.names = FALSE)
#}
```

结论：

-   **差异显著**：GuineaBissau的患病率 (4.60%) 显著高于其他国家，表明该国的瘘问题最为严重，需要紧急的公共卫生干预和资源投入。

-   **中等患病率国家**：Sierra Leone和Cote d'Ivoire的患病率也相对较高，表明这两个国家的瘘问题也需要重点关注。

-   **较低患病率国家**：Nigeria和Mali的患病率相对较低，表明这些国家的产瘘问题相对不那么严重，但仍需继续监测和干预以保持和进一步改善现状。

-   Togo**的患病率接近西非平均水平**，表明该国的瘘问题处于中等水平，同样需要适当的公共卫生干预。

```{r}
# --------------------------------------------------------
# Draw a bar chart
library(ggplot2)

# Combine all prevalence data into one dataframe
prevalence_df_list <- lapply(names(prevalence_list), function(var) {
  df <- prevalence_list[[var]]
  df$Variable <- var
  df[[var]] <- as.factor(df[[var]])  # Convert variable to factor
  return(df)
})

prevalence_df <- bind_rows(prevalence_df_list)

# Draw a horizontal grouped bar chart
plot_prevalence_by_variable_horizontal <- function(data, variable) {
  ggplot(data %>% filter(Variable == variable), aes_string(x = variable, y = "experienced_fistula", fill = variable)) +
    geom_bar(stat = "identity", position = position_dodge()) +
    geom_errorbar(aes(ymin = experienced_fistula - se, ymax = experienced_fistula + se), 
                  width = 0.2, position = position_dodge(0.9)) +
    labs(title = paste("Prevalence of Fistula by", variable),
         x = variable,
         y = "Prevalence of Fistula",
         fill = variable) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

# Output a list of graphs for all variables
horizontal_plots <- lapply(variables, function(var) plot_prevalence_by_variable_horizontal(prevalence_df, var))

for (plot in horizontal_plots) {
  print(plot)}

```

西非总体分析

distance（Getting medical help for self: distance to health facility）：1-big problem，2-not a big problem。说明距离医疗设施较远的患病率略高。

age_sex（Age at first sex）：1：8-14，5: 30-34，9: at first union（正式进入第一次婚姻或同居关系开始）。**早期开始性生活的风险**：在8-14岁和15-19岁开始性生活的女性中，产瘘的患病率较高，特别是在8-14岁开始的群体中，患病率最高。**中年女性的风险**：在30-34岁（有较大误差）和第一次婚姻或同居开始性生活的女性中，产瘘的患病率较高。

number_birth(Total children ever born): 生育数量较多的女性患病率较高，但在生育数量增加后，患病率有所下降。

religion: 穆斯林女性的患病率最高，而其他宗教信仰者的患病率较低。

residence: 城市女性的患病率略高于农村女性。

wealth: 较富裕群体的产瘘患病率最高，而最贫困的患病率较低。

education：教育水平越高，产瘘患病率越低，特别是高等教育的女性患病率最低。

occupation：不工作的人群患病率要高于有工作的人群。

contraception_use: 使用其他避孕方法的女性患病率最高，没有使用避孕方法的女性患病率次之。

delivery_place: **医疗设施分娩的患病率最高**：在医疗设施分娩的女性中，产瘘的患病率最高，为0.015，这与预期的情况不同。**非医疗设施分娩的患病率最低**：在非医疗设施分娩的女性中，产瘘的患病率最低，为0.010。**混合设施分娩的患病率居中**：在混合设施分娩的女性中，产瘘的患病率介于非医疗设施和医疗设施之间，为0.012。

delivery_professional：始终由专业人员接生的女性产瘘患病率最高，有时由专业人员接生的女性患病率最低

postpartum_care：始终进行产后检查的女性产瘘患病率较高。从不进行产后检查的女性产瘘患病率较低。

age：45-49岁的女性瘘患病率最高，其次是15-19岁。

```{r}
# --------------------------------------------------------
# Calculate the prevalence of different variables for each country
calculate_prevalence_by_country <- function(variable) {
  svyby(~experienced_fistula, as.formula(paste("~", variable, "+ country")), dhs_design, svymean)
}

variables <- c("distance", "age_sex", "number_birth", "religion", 
               "residence", "wealth", "education", "occupation", 
               "contraception_use", "delivery_place", 
               "age", "delivery_professional", "postpartum_care")

prevalence_by_country_list <- lapply(variables, calculate_prevalence_by_country)

names(prevalence_by_country_list) <- variables

#  Print grouped prevalence
for (var in names(prevalence_by_country_list)) {
  cat(paste("Prevalence for", var, "by country\n"))
  print(prevalence_by_country_list[[var]])
  cat("\n")
}
```

```{r fig.height=10, fig.width=10}
# --------------------------------------------------------
# Calculate the prevalence of different variables for each country in West Africa
# Combine all prevalence data into one dataframe
prevalence_by_country_df <- bind_rows(prevalence_by_country_list, .id = "Variable")

# Draw a horizontal grouped bar chart
plot_prevalence_by_variable_horizontal <- function(data, variable) {
  ggplot(data %>% filter(Variable == variable), aes(y = country, x = experienced_fistula, fill = country)) +
    geom_bar(stat = "identity", position = position_dodge()) +
    geom_errorbar(aes(xmin = experienced_fistula - se, xmax = experienced_fistula + se), 
                  width = 0.2, position = position_dodge(0.9)) +
    facet_wrap(~ .data[[variable]], scales = "free_x") +
    labs(title = paste("Prevalence of Fistula by Country and", variable),
         y = "Country",
         x = "Prevalence of Fistula",
         fill = variable) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

# Output a list of graphs for all variables
horizontal_plots <- lapply(variables, function(var) plot_prevalence_by_variable_horizontal(prevalence_by_country_df, var))

for (i in seq_along(horizontal_plots)) {
  print(horizontal_plots[[i]])
}

```

西非各国家分析

age：Guinea Bissau在所有年龄组中的瘘管患病率始终最高，这表明这是一个重大的公共卫生问题。Mali和**Sierra Leone**在某些年龄组中也表现出明显的患病率，尽管没有Guinea Bissau那么高。**Cote d‘lvoire**和**Togo的**患病率中等，而Nigeria在所有年龄组中的患病率通常较低。

distance（Getting medical help for self: distance to health facility）：1-big problem，2-not a big problem。Guinea Bissau在两个距离类别中瘘管患病率始终最高，凸显出距离医疗机构是一个关键问题。然而，“问题不大”类别的高患病率表明存在其他潜在的医疗保健问题。**Cote d‘lvoire的数据**显示，当距离不是问题时，发病率显著下降，这表明改善医疗设施可及性可以降低瘘管发病率。**Sierra Leone、Togo、Nigeria和Mali的**患病率普遍较低，两类之间的差异较小，表明医疗保健的可及性更加一致，与距离相关的障碍更少。

age_sex（Age at first sex）：Guinea-Bissau在大多数年龄段中瘘管的患病率始终最高，特别是年轻年龄组（8-24 岁），这表明早期性行为或早婚是重要的危险因素。Togo在“初次结合”类别中表现出中等流行率。Sierra Leone8-14 岁年龄组的患病率中等。Other countries**的**患病率较低或可忽略不计，表明在这些类别中与初次性行为年龄相关的风险因素较少。

number_birth(Total children ever born): Guinea-Bissau在大多数出生类别中瘘管患病率始终最高，表明无论出生人数多少，瘘管患病率都是一个持续存在的问题。Sierra Leone和Cote在生育数量1-3个的类别中表现出中等患病率，生育人数超过4个的患病率更低，这是一个值得注意的问题。Togo在高出生率类别（7、9 个生育孩子）中表现出一定的流行率。**Nigeria和Mali的**患病率较低或可忽略不计，表明孕产妇健康状况更好或与生育数量相关的风险因素较少。

religion: Guinea-Bissau**的**瘘管患病率在穆斯林和基督教徒中一直最高，这表明宗教信仰可能与该国的医疗保健机会和社会经济条件有关。Sierra Leone**的**穆斯林和基督教徒占比均处于中等水平，表明存在类似的问题，但程度较轻。**Cote d‘lvoire的**穆斯林和基督教徒的普及率都比较高。Togo在万物有灵论类别中表现出明显的流行度，在“无宗教”类别中也表现出一定的流行度，这表明文化或社会经济因素在起作用。基督教类别也表现出中等程度的流行度。**其他国家的**患病率较低或可忽略不计，表明这些类别中与宗教信仰相关的风险因素较少。

residence: Guinea-Bissau的城市和农村地区瘘管患病率一直最高，这表明不同类型的居住地都面临着广泛的医疗保健挑战。**Cote d‘lvoire**城镇和农村地区的发病率均处于中等水平。**Sierra Leone**和Togo在这两个类别中也表现出中等患病率，表明城市和农村地区存在类似的问题。**Nigeria和Mali的**城市和农村地区的患病率较低或可忽略不计，表明与居住在这些国家相关的风险因素较少。

wealth: Guinea-Bissau在所有财富类别中瘘管患病率最高，其中富裕五分之一人口患病率最高（\~0.075）。这表明，财富并不能显著降低该国的瘘管患病率。**Cote d‘lvoire**在各个财富类别中都表现出中等程度的流行率，其中最富裕的五分之一人口的流行率最高（\~0.021）。**Sierra Leone的**患病率从最贫穷的五分之一到最富裕的五分之一呈现下降趋势，这表明富裕的人更容易获得医疗保健且风险更低。Togo表现出多样性，其中最富裕的五分之一人口的患病率最高（\~0.039）。Mali和Nigeria在所有财富类别中都表现出较低的患病率，表明整体孕产妇保健更好或与瘘管相关的风险因素更少。

education：Guinea-Bissau在所有教育水平中瘘管患病率最高，其中中学教育水平的患病率最高（\~0.054）。这表明教育程度并不能显著降低该国的瘘管患病风险。**Cote d‘lvoire**各个教育水平的患病率均处于中等水平，未受过教育的人群患病率最高（\~0.012）。**Sierra Leone的**患病率从未受过教育的人群到受过高等教育的人群呈下降趋势，这表明教育程度越高，风险越低。Togo表现出多样性，在受过小学教育的人群中患病率最高（\~0.011）。Mali和Nigeria在所有教育水平上都表现出较低的患病率，表明整体孕产妇保健状况更好或与瘘管相关的风险因素更少。

occupation：Guinea-Bissau在工作和不工作中瘘管的患病率都最高，这表明是否就业都面临着广泛的医疗保健挑战。**Cote d‘lvoire**表现出明显的差异性，不工作的人群患病率最高。Nigeria和Mali的发病率相对较低。Togo和**Sierra Leone都表现为有工作的人群患病率更高。**

contraception_use: Guinea-Bissau在所有避孕措施类别中瘘管患病率最高，使用其他避孕措施的人群患病率最高（\~0.113）。这表明，该国使用的避孕措施并不能显著降低瘘管患病风险。**Cote d‘lvoire**在各种避孕方法的使用中，其流行率均处于中等水平，其中使用其他方法的人群的流行率最高（\~0.017）。**Mali的**整体患病率较低，使用其他方法的患病率最高（\~0.027）。Nigeria使用现代医学避孕措施的人群患病率较低（约 0.002）。**Sierra Leone**在未采取任何避孕措施的人群中，患病率为中等（\~0.017）。**在Togo，**未采取任何避孕措施的人群中，患病率为中等（\~0.012）。

delivery_place: Guinea-Bissau一直是所有分娩地点中瘘管患病率最高的国家，表明无论在何种分娩环境中，都面临着广泛的医疗保健挑战。Nigeria在所有分娩地点中瘘管的患病率一直是最低的，这表明该国整体的产妇保健状况更好，或与瘘管相关的风险因素更少。**Cote d‘lvoire**和Mali在非医疗机构中的患病率中等，科特迪瓦在医疗机构中的患病率略高，而马里的患病率较低。**Sierra Leone**和Togo在所有分娩地点都表现出类似的中等患病率，表明非医疗和医疗分娩环境都有改善的空间。

delivery_professional：Guinea-Bissau**：**各类接生专业人员中瘘管的发病率始终最高，这表明无论接生专业人员的资质如何，都面临着巨大的医疗保健挑战。Nigeria**：**在大多数类别中患病率最低，表明其整体孕产妇保健状况较好或与瘘管相关的风险因素较少。**Cote d‘lvoire：**患病率中等，由非专业人员接生时患病率更高。**Mali：**总体患病率较低，混合专业人员患病率略高。**Sierra Leone：**专业和混合专业人员的患病率相似，为中等，表明这两个类别都有改进的空间。**Togo：**在专业和非专业助产分娩中患病率中等。

postpartum_care：Guinea-Bissau**：：**各级产后护理中瘘管的患病率最高，表明无论产后护理实践如何，产妇保健都面临着重大挑战。**Mali：**各级产后护理的患病率始终较低，表明产妇保健管理较好。**Nigeria：**混合产后护理的患病率中等，且效果更好，表明医疗保健实践存在一定差异。**Sierra Leone：**患病率中等，且“始终检查”的比例较高，表明需要提高产后护理的一致性。**Togo：**显示“总是检查”和“总是不检查”的患病率中等，混合的患病率没有显著数据，表明产后护理实践不一致。**Cote d‘lvoire：**显示“总是检查”和“总是不检查”之间存在显著差异，混合时没有显著数据，表明产后护理质量存在差异。

```{r}
# Plotting a heat map
ggplot(prevalence_by_country_df, aes(x = Variable, y = country, fill = experienced_fistula)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red") +
  labs(title = "Heatmap of Fistula Prevalence by Country and Various Variables",
       x = "Variable",
       y = "Country",
       fill = "Prevalence of Fistula") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

1.  Guinea-Bissau：

    -   在多个变量中表现出较高的瘘管患病率，尤其是在**避孕使用、**年龄、**分娩地点、距离、教育、residence、职业、财富**和**产后护理**方面。

    -   多种因素导致的广泛高发病率表明瘘管存在严重的公共卫生问题。

2.  Côte d'Ivoire：

    -   **在教育、财富**和避孕使用方面表现较突出。

3.  Mali：

    -   **显示出避孕使用**的中等流行率。

4.  Nigeria：

    -   总体而言，大多数变量的患病率较低，但在就业和距离方面患病率稍高。

5.  Sierra Leone：

    -   **在年龄、分娩是否专业、与医疗措施距离**和residence方面表现出中等程度的流行。

6.  Togo：

    -   **在wealth、第一次性生活年龄、与医疗措施距离、生产是否专业、生育人数**方面表现出流行。

-   Guinea-Bissau在各项变量中表现出最高和最广泛的患病率，表明存在严重且多方面的公共卫生挑战。

    Mali需要注意避用使用和年龄，表明需要采取有针对性的干预措施。

    Nigeria总体发病率较低，但需要注意就业风险。

    Sierra Leone和Cote、Togo在不同变量中表现出中等患病率，表明需要有针对性的卫生政策和干预措施 library(ggplot2)

```{r}
# --------------------------------------------------------
# Feature Analysis
# West Africa
# *Crosstab
# ——Showing the prevalence of fistula under different combinations of characteristics

# 1.Personal and Family Background
background <- svyby(~ experienced_fistula, ~ age + religion + residence, dhs_design, svymean)
individual_family <- as.data.frame(background)
print(individual_family)
# 2.Economic and Social Status
economic <- svyby(~ experienced_fistula, ~ wealth + education + occupation, dhs_design, svymean)
economic_social <- as.data.frame(economic)
print(economic_social)
# 3.Medical Services and Health Conditions
health <- svyby(~ experienced_fistula, ~ postpartum_care + delivery_place + delivery_professional + distance, dhs_design, svymean)
healthcare_health <- as.data.frame(health)
print(healthcare_health)
# 4.Family Planning and Reproductive Health
reproductive <- svyby(~ experienced_fistula, ~ contraception_use + number_birth + age_sex, dhs_design, svymean)
family_reproductive <- as.data.frame(reproductive)
print(family_reproductive)


# *Visualization
# 1.Personal and Family Background
ggplot(individual_family, aes(x = age, y = experienced_fistula, fill = factor(religion))) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ residence) +
  labs(title = "Fistula Prevalence by Age, Religion, and Residence", x = "age", y = "prevalence") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
# Add the residence tag
grid.text("residence", x = 0.45, y = 0.95, gp = gpar(fontsize = 12, fontface = "bold"))

# 2.Economic and Social Status
ggplot(economic_social, aes(x = wealth, y = experienced_fistula, fill = factor(occupation))) + geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ education) +
  labs(title = "Fistula Prevalence by Wealth, Education, and Occupation", x = "wealth", y = "prevalence") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
# Add the education tag
grid.text("education", x = 0.45, y = 0.95, gp = gpar(fontsize = 12, fontface = "bold"))

# 3.Medical Services and Health Conditions
ggplot(healthcare_health, aes(x = delivery_place, y = experienced_fistula, fill = factor(postpartum_care))) +
  geom_bar(stat = "identity", position = "dodge") +  # 使用堆叠柱状图
  facet_grid(delivery_professional ~ distance) +
  labs(title = "Fistula Prevalence by Delivery Place, Postpartum Care, Delivery Professional, and Distance", x = "Delivery Place", y = "Prevalence", fill = "Postpartum Care") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
# Add the distance and delivery professional tag
grid.text("distance", x = 0.45, y = 0.95, gp = gpar(fontsize = 12, fontface = "bold"))
grid.text("delivery professional", x = 0.88, y = 0.5, gp = gpar(fontsize = 12, fontface = "bold"), rot = 90)

# 4.Family Planning and Reproductive Health
ggplot(family_reproductive, aes(x = age_sex, y = experienced_fistula, fill = factor(number_birth))) + geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ contraception_use) +
  labs(title = "Fistula Prevalence by Total Birth, Age at First Sex, and Contraception Use", x = "age at first sex", y = "prevalence") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
# Add the contraception use tag
grid.text("contraception use", x = 0.45, y = 0.965, gp = gpar(fontsize = 12, fontface = "bold"))
```

```{r}
# West Africa Countries
# 1.Personal and Family Background
# Generate crosstabs and visualizations
generate_crosstabs_and_plots <- function(design, country_name) {
  # Filter data by country
  subset_design <- subset(design, country == country_name)
  background <- svyby(~experienced_fistula, ~age + religion + residence, subset_design, svymean)
  individual_family <- as.data.frame(background)
  
  # Plot
  plot <- ggplot(individual_family, aes(x = age, y = experienced_fistula, fill = factor(religion))) +
    geom_bar(stat = "identity", position = "dodge") +
    facet_wrap(~ residence) +
    labs(title = paste("Fistula Prevalence by Age, Religion, and Residence in", country_name),
         x = "Age",
         y = "Prevalence") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5))
  
  return(plot)
}

# Contain a list include all countries
countries <- unique(data1$country)

# Crosstab and Plot
plots <- lapply(countries, function(country) {
  generate_crosstabs_and_plots(dhs_design, country)
})

for (plot in plots) {
  print(plot)
  # Add the residence tag
  grid.text("Residence", x = 0.45, y = 0.95, gp = gpar(fontsize = 12, fontface = "bold"))
}
```

```{r}
# 2.Economic and Social Status
# Generate crosstabs and visualizations
generate_crosstabs_and_plots <- function(design, country_name) {
  # Filter data by country
  subset_design <- subset(design, country == country_name)
  economic <- svyby(~ experienced_fistula, ~ wealth + education + occupation, subset_design, svymean)
  economic_social <- as.data.frame(economic)
  
  # Plot
  plot <- ggplot(economic_social, aes(x = wealth, y = experienced_fistula, fill = factor(occupation))) + geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ education) +
  labs(title = paste("Fistula Prevalence by Wealth, Education, and Occupation in", country_name), x = "wealth", y = "prevalence") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
  
  return(plot)
}

# Contain a list include all countries
countries <- unique(data1$country)

# Crosstab and Plot
plots <- lapply(countries, function(country) {
  generate_crosstabs_and_plots(dhs_design, country)
})

for (plot in plots) {
  print(plot)
  # Add the education tag
  grid.text("education", x = 0.45, y = 0.95, gp = gpar(fontsize = 12, fontface = "bold"))
}
```

```{r}
# 3.Medical Services and Health Conditions
# Generate crosstabs and visualizations
generate_crosstabs_and_plots <- function(design, country_name) {
  # Filter data by country
  subset_design <- subset(design, country == country_name)
  health <- svyby(~ experienced_fistula, ~ postpartum_care + delivery_place + delivery_professional + distance, subset_design, svymean)
  healthcare_health <- as.data.frame(health)
  
  # Plot
  plot <- ggplot(healthcare_health, aes(x = delivery_place, y = experienced_fistula, fill = factor(postpartum_care))) +
  geom_bar(stat = "identity", position = "dodge") +  # 使用堆叠柱状图
  facet_grid(delivery_professional ~ distance) +
  labs(title = paste("Fistula Prevalence by Delivery Place, Postpartum Care, Delivery Professional, and Distance",country_name), x = "Delivery Place", y = "Prevalence", fill = "Postpartum Care") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
  
  return(plot)
}

# Contain a list include all countries
countries <- unique(data1$country)

# Crosstab and Plot
plots <- lapply(countries, function(country) {
  generate_crosstabs_and_plots(dhs_design, country)
})

for (plot in plots) {
  print(plot)
  # Add the distance, delivery professional tag
  grid.text("distance", x = 0.45, y = 0.95, gp = gpar(fontsize = 12, fontface = "bold"))
  grid.text("delivery professional", x = 0.88, y = 0.5, gp = gpar(fontsize = 12, fontface = "bold"), rot = 90)}
```

```{r}
# 4.Family Planning and Reproductive Health
# Generate crosstabs and visualizations
generate_crosstabs_and_plots <- function(design, country_name) {
  # Filter data by country
  subset_design <- subset(design, country == country_name)
  reproductive <- svyby(~ experienced_fistula, ~ contraception_use + number_birth + age_sex, subset_design, svymean)
  family_reproductive <- as.data.frame(reproductive)
  
  # Plot
  plot <- ggplot(family_reproductive, aes(x = age_sex, y = experienced_fistula, fill = factor(number_birth))) + geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ contraception_use) +
  labs(title = paste("Fistula Prevalence by Total Birth, Age at First Sex, and Contraception Use",country_name), x = "age at first sex", y = "prevalence") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
  
  return(plot)
}

# Contain a list include all countries
countries <- unique(data1$country)

# Crosstab and Plot
plots <- lapply(countries, function(country) {
  generate_crosstabs_and_plots(dhs_design, country)
})

for (plot in plots) {
  print(plot)
  # Add the contraception use tag
  grid.text("contraception use", x = 0.45, y = 0.965, gp = gpar(fontsize = 12, fontface = "bold"))
}
```

```{r}
# Multiple Correspondence Analysis (MCA)
library(FactoMineR)
library(factoextra)
library(plotly)

categorical_vars <- c("experienced_fistula", "age", "distance", "age_sex", "religion", "residence", "wealth", "education", "occupation", "contraception_use", "delivery_place", "delivery_professional", "postpartum_care", "number_birth")


# Categorical variables are converted to factor types
data2 <- data1 %>%
  mutate(across(all_of(categorical_vars), as.factor))

str(data2[categorical_vars])

# West Africa
# MCA
mca_result <- MCA(data2[categorical_vars], graph = FALSE)

# MCA Plot
mca_biplot <- fviz_mca_biplot(mca_result, repel = TRUE, ggtheme = theme_minimal())
mca_biplot
# ggplot ——> plotly
#mca_biplot_plotly <- ggplotly(mca_biplot)
#mca_biplot_plotly

# Variable Contribution
fviz_contrib(mca_result, choice = "var", axes = 1, top = 10)
fviz_contrib(mca_result, choice = "var", axes = 2, top = 10) 

```

```{r}
# West Africa Counties
# MCA analysis for each country
all_vars <- c("experienced_fistula", "age", "distance", "age_sex", "religion", "residence", "wealth", "education", "occupation", "contraception_use", "delivery_place", "delivery_professional", "postpartum_care", "number_birth", "country")

categorical_vars <- c("experienced_fistula", "age", "distance", "age_sex", "religion", "residence", "wealth", "education", "occupation", "contraception_use", "delivery_place", "delivery_professional", "postpartum_care", "number_birth")

# Categorical variables are converted to factor types
data3 <- data1 %>%
  mutate(across(all_of(all_vars), as.factor))

# Use split to group by country
data_split <- split(data3, data3$country)

# MCA analysis for each country
lapply(names(data_split), function(country_name) {
  country_data <- data_split[[country_name]]
  
  # Select categorical variables
  mca_data <- country_data %>% select(all_of(categorical_vars))
  
  mca_result <- MCA(mca_data, graph = FALSE)
  
  # MCA Plot
  mca_biplot <- fviz_mca_biplot(mca_result, repel = TRUE, ggtheme = theme_minimal()) +
          ggtitle(paste("MCA Biplot for", country_name))
  # Variable Contribution
  var_contrib_1 <- fviz_contrib(mca_result, choice = "var", axes = 1, top = 10) +
    ggtitle(paste("Variable Contribution - Axis 1 for", country_name))
  var_contrib_2 <- fviz_contrib(mca_result, choice = "var", axes = 2, top = 10) +
    ggtitle(paste("Variable Contribution - Axis 2 for", country_name))
  
  print(mca_biplot)
  print(var_contrib_1)
  print(var_contrib_2)
})

```

1.3 Data Analysis

1.3.1 Bivariate Analysis

```{r}
# Bivariate analysis
glm_fistula_age <- svyglm(experienced_fistula ~ age, design = dhs_design, family = quasibinomial())
summary(glm_fistula_age)

# Chi-square test
chisq_1 <- svychisq(~age + experienced_fistula, design = dhs_design)
print(chisq_1)

```

```{r}
glm_fistula_distance <- svyglm(experienced_fistula ~ distance, design = dhs_design, family = quasibinomial())
summary(glm_fistula_distance)

# Chi-square test
chisq_2 <- svychisq(~distance + experienced_fistula, design = dhs_design)
print(chisq_2)

```

```{r}
glm_fistula_age_sex <- svyglm(experienced_fistula ~ age_sex, design = dhs_design, family = quasibinomial())
summary(glm_fistula_age_sex)

# Chi-square test
chisq_3 <- svychisq(~age_sex + experienced_fistula, design = dhs_design)
print(chisq_3)
```

Logistic regression results close to significance:

Although age_sex did not reach significance in the univariate logistic regression, its p-value is close to 0.05, which indicates that it may become significant when combined with other variables in a multivariate analysis.

Chi-square test is significant:

The chi-square test result is significant, indicating that age_sex is associated with experienced_fistula. Even though this association is not significant in the logistic regression, it may have explanatory power in the multivariate model.

```{r}
glm_fistula_number_birth <- svyglm(experienced_fistula ~ number_birth, design = dhs_design, family = quasibinomial())
summary(glm_fistula_number_birth)

# Chi-square test
chisq_4 <- svychisq(~number_birth + experienced_fistula, design = dhs_design)
print(chisq_4)
```

-   **逻辑回归的显著性**：

    -   逻辑回归结果表明 `number_birth` 对 `experienced_fistula` 有显著影响，应当重视这个发现。

-   **变量的理论重要性**：

    -   如果 `number_birth` 是一个在理论或文献中被认为重要的变量，即使卡方检验结果不显著，也应保留。

-   **模型的解释力**：

    -   在多变量模型中，`number_birth` 可能与其他变量共同作用，增加模型的解释力。

```{r}
glm_fistula_religion <- svyglm(experienced_fistula ~ religion, design = dhs_design, family = quasibinomial())
summary(glm_fistula_religion)

# Chi-square test
chisq_5 <- svychisq(~religion + experienced_fistula, design = dhs_design)
print(chisq_5)
```

```{r}
glm_fistula_residence <- svyglm(experienced_fistula ~ residence, design = dhs_design, family = quasibinomial())
summary(glm_fistula_residence)

# Chi-square test
chisq_6 <- svychisq(~residence + experienced_fistula, design = dhs_design)
print(chisq_6)
```

```{r}
glm_fistula_wealth <- svyglm(experienced_fistula ~ wealth, design = dhs_design, family = quasibinomial())
summary(glm_fistula_wealth)

# Chi-square test
chisq_7 <- svychisq(~wealth + experienced_fistula, design = dhs_design)
print(chisq_7)
```

```{r}
glm_fistula_education <- svyglm(experienced_fistula ~ education, design = dhs_design, family = quasibinomial())
summary(glm_fistula_education)

# Chi-square test
chisq_8 <- svychisq(~education + experienced_fistula, design = dhs_design)
print(chisq_8)
```

```{r}
glm_fistula_occupation <- svyglm(experienced_fistula ~ occupation, design = dhs_design, family = quasibinomial())
summary(glm_fistula_occupation)

# Chi-square test
chisq_9 <- svychisq(~occupation + experienced_fistula, design = dhs_design)
print(chisq_9)
```

```{r}
glm_fistula_contraception_use <- svyglm(experienced_fistula ~ contraception_use, design = dhs_design, family = quasibinomial())
summary(glm_fistula_contraception_use)

# Chi-square test
chisq_10 <- svychisq(~contraception_use + experienced_fistula, design = dhs_design)
print(chisq_10)
```

```{r}
glm_fistula_delivery_place <- svyglm(experienced_fistula ~ delivery_place, design = dhs_design, family = quasibinomial())
summary(glm_fistula_delivery_place)

# Chi-square test
chisq_11 <- svychisq(~delivery_place + experienced_fistula, design = dhs_design)
print(chisq_11)
```

```{r}
glm_fistula_delivery_professional <- svyglm(experienced_fistula ~ delivery_professional, design = dhs_design, family = quasibinomial())
summary(glm_fistula_delivery_professional)

# Chi-square test
chisq_12 <- svychisq(~delivery_professional + experienced_fistula, design = dhs_design)
print(chisq_12)
```

```{r}
glm_fistula_postpartum_care <- svyglm(experienced_fistula ~ postpartum_care, design = dhs_design, family = quasibinomial())
summary(glm_fistula_postpartum_care)

# Chi-square test
chisq_13 <- svychisq(~postpartum_care + experienced_fistula, design = dhs_design)
print(chisq_13)
```

"age", "distance", "age_sex", "number_birth", "religion", "residence", "wealth", "education", "occupation", "contraception_use", "delivery_place", "delivery_professional", "postpartum_care"

```{r}
# 选择要进行相关性分析的变量
selected_vars <- data1[, c("age", "distance", "age_sex", "number_birth", "religion", "residence", "wealth", "education", "occupation", "contraception_use", "delivery_place", "delivery_professional", "postpartum_care")]

# 计算相关性矩阵
correlation_matrix <- cor(selected_vars, use = "complete.obs", method = "pearson")

library(ggcorrplot)
ggcorrplot(correlation_matrix, hc.order = TRUE, type = "lower", lab = TRUE)


```

------------------------------------------------------------------------

```{r}
# --------------------------------------------------------
# Multivariate analysis
#glm_fistula_multi <- svyglm(experienced_fistula ~ age + distance + age_sex + number_birth + religion + residence + wealth + education + occupation + contraception_use + delivery_place + delivery_professional + postpartum_care, design = dhs_design, family = quasibinomial())
#summary(glm_fistula_multi)
```

```{r}
library(survey)

# 假设你有一个按国家分层的数据集
countries <- unique(data1$country)

# 缩放权重
data1$V005_scaled <- data1$V005 / 1000000

# 遍历每个国家，分别进行回归分析
for (country in countries) {
  country_data <- data1 %>% filter(country == !!country)
  
  # 创建抽样设计对象
  svydesign_country <- svydesign(id = ~1, weights = ~V005_scaled, data = country_data)
  
  # 使用 svyglm 进行加权回归分析
  glm_country <- svyglm(experienced_fistula ~ age + age_sex + distance + number_birth +
                          religion + residence + wealth + education + occupation + 
                          contraception_use + delivery_place + delivery_professional + 
                          postpartum_care, 
                        design = svydesign_country, 
                        family = quasibinomial())
  
  # 打印每个国家的分析结果
  cat("Country:", country, "\n")
  print(summary(glm_country))
  
  # 提取回归模型的设计矩阵
  model_matrix_country <- model.matrix(glm_country)
  
  # 计算 VIF
  vif_values_country <- vif(glm_country)
  
  # 打印 VIF 值
  cat("VIF values for", country, ":\n")
  print(vif_values_country)
  cat("\n\n")
}

# 对完整的数据集进行整体回归分析
# 创建完整数据集的抽样设计对象
svydesign_overall <- svydesign(id = ~1, weights = ~V005_scaled, data = data1)

# 使用 svyglm 进行整体加权回归分析
glm_overall <- svyglm(experienced_fistula ~ age + age_sex + distance + number_birth +
                        religion + residence + wealth + education + occupation + 
                        contraception_use + delivery_place + delivery_professional + 
                        postpartum_care, 
                      design = svydesign_overall, 
                      family = quasibinomial())

# 打印整体回归分析的结果
summary(glm_overall)

# 提取整体模型的设计矩阵
model_matrix_overall <- model.matrix(glm_overall)

# 计算 VIF
vif_values_overall <- vif(glm_overall)

# 打印整体模型的 VIF 值
cat("VIF values for overall model:\n")
print(vif_values_overall)

```

```{r}
# 筛选出 Cote d'Ivoire 的数据
country_data <- data1 %>% filter(country == "Cote d'Ivoire")

glm_cote <- svyglm(experienced_fistula ~ age + age_sex + distance + number_birth +
                        religion + wealth + education + occupation + 
                        contraception_use + delivery_place + delivery_professional + 
                        postpartum_care, 
                      design = svydesign_country, 
                      family = quasibinomial())
summary(glm_cote)
# 提取整体模型的设计矩阵
model_matrix_cote <- model.matrix(glm_cote)

# 计算 VIF
vif_values_cote <- vif(glm_cote)

# 打印整体模型的 VIF 值
cat("VIF values for cote model:\n")
print(vif_values_cote)


# 筛选出 Mali 的数据
country_data <- data1 %>% filter(country == "Mali")

glm_mali <- svyglm(experienced_fistula ~ age_sex + distance + number_birth +
                     religion + residence + wealth + education + occupation + 
                     contraception_use + delivery_place + delivery_professional + 
                     postpartum_care, 
                   design = svydesign_country, 
                   family = quasibinomial())
summary(glm_mali)
# 提取整体模型的设计矩阵
model_matrix_mali <- model.matrix(glm_mali)

# 计算 VIF
vif_values_mali <- vif(glm_mali)

# 打印整体模型的 VIF 值
cat("VIF values for mali model:\n")
print(vif_values_mali)



# 筛选出 Nigeria 的数据
country_data <- data1 %>% filter(country == "Nigeria")

glm_nigeria <- svyglm(experienced_fistula ~ age + age_sex + distance + number_birth +
                     religion + residence + wealth + education + occupation + 
                     delivery_place + delivery_professional + 
                     postpartum_care, 
                   design = svydesign_country, 
                   family = quasibinomial())
summary(glm_nigeria)
# 提取整体模型的设计矩阵
model_matrix_nigeria <- model.matrix(glm_nigeria)

# 计算 VIF
vif_values_nigeria <- vif(glm_nigeria)

# 打印整体模型的 VIF 值
cat("VIF values for nigeria model:\n")
print(vif_values_nigeria)



# 筛选出 Togo 的数据
country_data <- data1 %>% filter(country == "Togo")

glm_togo <- svyglm(experienced_fistula ~ age + age_sex + distance + number_birth +
                        religion + residence + education + occupation + 
                        contraception_use + delivery_place + delivery_professional + 
                        postpartum_care, 
                      design = svydesign_country, 
                      family = quasibinomial())
summary(glm_togo)
# 提取整体模型的设计矩阵
model_matrix_togo <- model.matrix(glm_togo)

# 计算 VIF
vif_values_togo <- vif(glm_togo)

# 打印整体模型的 VIF 值
cat("VIF values for togo model:\n")
print(vif_values_togo)


```

Decision Tree (West Aferica)

Decision tree identification of key factors

```{r fig.height=10, fig.width=10}
# --------------------------------------------------------
# Decision Tree
library(dplyr)
library(rpart)
library(rpart.plot)
library(caret)


# Remove the country column
data_tree <- data1 %>% select(-country)

# Convert the target variable into a factor variable
data_tree$experienced_fistula <- as.factor(data_tree$experienced_fistula)

# Processing weight
data_tree$V005 <- data_tree$V005 / 1000000


# Downsampling
set.seed(123)  
data_downsampled <-
  downSample(
    x = data_tree %>% select(-experienced_fistula),
    y = data_tree$experienced_fistula,
    yname = "experienced_fistula"
  )

# Make sure V005 is a numeric variable
data_downsampled$V005 <- as.numeric(data_downsampled$V005)

# Split the dataset into training and testing sets
set.seed(123)
train_index <- createDataPartition(data_downsampled$experienced_fistula, p = 0.8, list = FALSE)[,1]
train_data <- data_downsampled[train_index, ]
test_data <- data_downsampled[-train_index, ]

# Training a decision tree model
set.seed(123)
tree_model <- rpart(experienced_fistula ~ . - V005, data = train_data, weights = train_data$V005, , cp = 0.01, control = rpart.control(maxdepth = 10))

# Plot
rpart.plot(tree_model)

# Extract and display feature importance
importance <- tree_model$variable.importance
importance <- sort(importance, decreasing = TRUE)  # Sort in descending order

# Print the feature importance
print(importance)

# Optional: Plot the feature importance
barplot(importance, main = "Feature Importance", las = 2, col = "lightblue", cex.names = 0.8)
```

Predict and calculate model performance indicators on the test set

```{r}
# 使用测试集进行预测
test_predictions <- predict(tree_model, newdata = test_data, type = "class")

# 生成混淆矩阵
confusion_matrix <- confusionMatrix(test_predictions, test_data$experienced_fistula)
print(confusion_matrix)

```

```{r}
# --------------------------------------------------------
# Random Forest
library(caret)

# Remove the country column
data_model <- data1 %>% select(-country)

# experienced_fistula is a factor variable
data_model$experienced_fistula <- as.factor(data_model$experienced_fistula)

# Downsampling
set.seed(123)
data_downsampled <- downSample(
  x = data_model %>% select(-experienced_fistula),
  y = data_model$experienced_fistula,
  yname = "experienced_fistula"
)

# Weight Processing
data_downsampled$V005 <- data_downsampled$V005 / 1000000  

# The sampled target variables are changed from 1 and 2 to 0 and 1
data_downsampled$experienced_fistula <- as.numeric(data_downsampled$experienced_fistula) - 1

# All columns except V005 are factor types
data_downsampled <- data_downsampled %>%
  mutate(across(-V005, as.factor))

# V005 is a numeric variable
data_downsampled$V005 <- as.numeric(data_downsampled$V005)

# Split the dataset into training and testing sets
set.seed(123)
train_index <- createDataPartition(data_downsampled$experienced_fistula, p = 0.8, list = FALSE)
train_data <- data_downsampled[train_index, ]
test_data <- data_downsampled[-train_index, ]

# Setting up cross validation
train_control <- trainControl(method = "cv", number = 10)

set.seed(123)

# Parameter Optimization
tune_grid <- expand.grid(mtry = c(3, 5, 7))

rf_model <- train(
  experienced_fistula ~ . - V005,
  data = train_data,
  method = "rf",
  trControl = train_control,
  weights = train_data$V005,
  tuneGrid = tune_grid,
  metric = "Accuracy",
  ntree = 200
)

print(summary(rf_model))

# Random Forest Model Prediction
rf_predictions <- predict(rf_model, newdata = test_data)
rf_predictions <- factor(rf_predictions, levels = levels(test_data$experienced_fistula))

# Random Forest Model Confusion Matrix
rf_confusion_matrix <- confusionMatrix(rf_predictions, test_data$experienced_fistula)
print(rf_confusion_matrix)

# Feature Importance
importance_scores <- varImp(rf_model, scale = FALSE)
print(importance_scores)
```

```{r}
# Precision, Recall, F1 score
library(yardstick)

# Create a data frame
rf_results <- tibble(
  truth = test_data$experienced_fistula,
  estimate = rf_predictions)

# Calculate Precision, Recall, F1 score
metrics <- metric_set(precision, recall, f_meas)
results <- metrics(rf_results, truth = truth, estimate = estimate)
print(results)
```

```{r}
# ROC
library(pROC)

# Predicted probabilities
rf_prob <- predict(rf_model, newdata = test_data, type = "prob")[, 2]

# ROC Curve
roc_curve <- roc(test_data$experienced_fistula, rf_prob)

# ROC Plot
plot(roc_curve, main = "ROC Curve")

# AUC
roc_auc <- auc(roc_curve)
print(paste("AUC for ROC:", roc_auc))
```

```{r}
# PR
library(PRROC)

# PR Curve
pr_curve <- pr.curve(scores.class0 = rf_prob, weights.class0 = as.numeric(test_data$experienced_fistula) - 1, curve = TRUE)

# PR Plot
plot(pr_curve, main = "PR Curve")

# AUC
pr_auc <- pr_curve$auc.integral
print(paste("AUC for PR Curve:", pr_auc))
```

West Africa Countries

```{r}
# Bivariate analysis
bivariate_analysis <- function(design, variables) {
  results <- list()
  
  for (var in variables) {
    formula <- as.formula(paste("experienced_fistula ~", var))
    glm_model <- svyglm(formula, design = design, family = quasibinomial())
    glm_summary <- summary(glm_model)
    
    # Chi-square test
    chisq_test <- svychisq(as.formula(paste("~", var, "+ experienced_fistula")), design = design)
    
    # Result
    results[[var]] <- list(
      glm_summary = glm_summary,
      chisq_test = chisq_test
    )
  }
  
  return(results)
}

variables <- c("age", "distance", "age_sex", "number_birth", "religion", "residence", "wealth", "education", "occupation", "contraception_use", "delivery_place", "delivery_professional", "postpartum_care")
```

```{r}
# Cote d'lvoire
Cote_data <- subset(dhs_design, country == "Cote d'lvoire")


Cote_results <- bivariate_analysis(Cote_data, variables)
print(Cote_results)
```

```{r}
# Cote d'lvoire
# Multivariate analysis

glm_fistula_Cote <- svyglm(experienced_fistula ~ age + distance + age_sex + number_birth + religion + wealth + education + occupation + contraception_use + delivery_place + delivery_professional + postpartum_care, design = Cote_data, family = quasibinomial())
summary(glm_fistula_Cote)

library(car)
# 计算 VIF
vif_values <- vif(glm_fistula_Cote)
print(vif_values)

```

```{r}
# GuineaBissau
GuineaBissau_data <- subset(dhs_design, country == "GuineaBissau")

# Bivariate analysis
GuineaBissau_results <- bivariate_analysis(GuineaBissau_data, variables)
print(GuineaBissau_results)
```

```{r}
# GuineaBissau
# Multivariate analysis

glm_fistula_GuineaBissau <- svyglm(experienced_fistula ~ age + distance + age_sex + number_birth + religion + residence + wealth + education + occupation + contraception_use + delivery_place + delivery_professional + postpartum_care, design = GuineaBissau_data, family = quasibinomial())
summary(glm_fistula_GuineaBissau)
```

```{r}
# Mali
Mali_data <- subset(dhs_design, country == "Mali")

# Bivariate analysis
Mali_results <- bivariate_analysis(Mali_data, variables)
print(Mali_results)
```

```{r}
# Mali
# Multivariate analysis

glm_fistula_Mali <- svyglm(experienced_fistula ~ age + distance + age_sex + number_birth + religion + residence + wealth + education + occupation + contraception_use + delivery_place + delivery_professional + postpartum_care, design = Mali_data, family = quasibinomial())
summary(glm_fistula_Mali)
```

```{r}
# Nigeria
Nigeria_data <- subset(dhs_design, country == "Nigeria")

# Bivariate analysis
Nigeria_results <- bivariate_analysis(Nigeria_data, variables)
print(Nigeria_results)
```

```{r}
# Nigeria
# Multivariate analysis

glm_fistula_Nigeria <- svyglm(experienced_fistula ~ age + distance + age_sex + number_birth + religion + residence + wealth + education + occupation + contraception_use + delivery_place + delivery_professional + postpartum_care, design = Nigeria_data, family = quasibinomial())
summary(glm_fistula_Nigeria)
```

```{r}
# SierraLeone
SierraLeone_data <- subset(dhs_design, country == "SierraLeone")

# Bivariate analysis
SierraLeone_results <- bivariate_analysis(SierraLeone_data, variables)
print(SierraLeone_results)
```

```{r}
# SierraLeone
# Multivariate analysis

glm_fistula_SierraLeone <- svyglm(experienced_fistula ~ age + distance + age_sex + number_birth + religion + residence + wealth + education + occupation + contraception_use + delivery_place + delivery_professional + postpartum_care, design = SierraLeone_data, family = quasibinomial())
summary(glm_fistula_SierraLeone)
```

```{r}
# Togo
Togo_data <- subset(dhs_design, country == "Togo")

# Bivariate analysis
Togo_results <- bivariate_analysis(Togo_data, variables)
print(Togo_results)
```

```{r}
# Togo
# Multivariate analysis

glm_fistula_Togo <- svyglm(experienced_fistula ~ age + distance + age_sex + number_birth + religion + residence + wealth + education + occupation + contraception_use + delivery_place + delivery_professional + postpartum_care, design = Togo_data, family = quasibinomial())
summary(glm_fistula_Togo)
```

West Africa Countries decision tree

```{r}

# 循环每个country训练决策树
countries <- unique(data1$country)

# 遍历每个国家
for (country in countries) {
  # 筛选出当前国家的数据
  data_country <- data1 %>% filter(country == !!country)
  
  # 移除country列
  data_tree <- data_country %>% select(-country)
  
  # 将目标变量转换为因子变量
  data_tree$experienced_fistula <- as.factor(data_tree$experienced_fistula)
  
  # 处理权重
  data_tree$V005 <- data_tree$V005 / 1000000
  
  # Downsampling
  set.seed(123)
  data_downsampled <- downSample(
    x = data_tree %>% select(-experienced_fistula),
    y = data_tree$experienced_fistula,
    yname = "experienced_fistula"
  )
  
  # 确保V005是数值型变量
  data_downsampled$V005 <- as.numeric(data_downsampled$V005)
  
  # 将数据集拆分为训练集和测试集
  set.seed(123)
  train_index <- createDataPartition(data_downsampled$experienced_fistula, p = 0.8, list = FALSE)[,1]
  train_data <- data_downsampled[train_index, ]
  test_data <- data_downsampled[-train_index, ]
  
  # 训练决策树模型
  set.seed(123)
  tree_model <- rpart(experienced_fistula ~ . - V005, data = train_data, weights = train_data$V005, cp = 0.01, control = rpart.control(maxdepth = 5))
  
  # 绘制决策树
  title <- paste("Decision Tree:", country)
  rpart.plot(tree_model, main = title)
  
  # Extract and display feature importance
  importance <- tree_model$variable.importance
  importance <- sort(importance, decreasing = TRUE)  # Sort in descending order

  # Print the feature importance
  print(importance)

  # Optional: Plot the feature importance
  barplot(importance, main = "Feature Importance", las = 2, col = "lightblue", cex.names = 0.8)
  
  # 在测试集上进行预测
  predictions <- predict(tree_model, newdata = test_data, type = "class")
  
  # 生成混淆矩阵
  confusion <- confusionMatrix(predictions, test_data$experienced_fistula)
  print(paste("Confusion Matrix for", country))
  print(confusion)
}

```

从这些决策树的结果中，可以总结出以下几点关于不同国家与目标变量（是否经历fistula）之间的关系。

### 1. **共同变量的重要性**

-   **财富（wealth）**：在多个国家（如Guinea-Bissau, Nigeria, Sierra Leone）中，财富水平是一个重要的分割变量，显示出财富较低的群体更可能患有fistula。
-   **教育（education）**：教育水平在一些国家（如Mali）中是一个关键因素，教育水平较低的群体似乎与fistula有更高的关联性。
-   **宗教（religion）**：在Cote d'Ivoire中，宗教是首个分割变量，表明不同宗教信仰的群体在经历fistula方面有显著差异。

### 2. **国家特有的影响因素**

-   **Sierra Leone**：产后护理（postpartum care）和分娩地点（delivery place）是重要的决策点，表明产后护理和分娩地点的选择可能对预防fistula起关键作用。
-   **Togo**：出生次数（number of births）是唯一的分割变量，显示出生次数为0的群体与经历fistula的风险关系显著。
-   **Nigeria**：年龄（age）和居住地（residence）是重要的分割因素，较年轻和在城市地区居住的女性更有可能经历fistula。

### 3. **节点中的概率解释**

-   每个节点中的值表示的是当前节点中目标变量的平均值，即该节点中属于“经历fistula”的比例。例如，在Cote d'Ivoire的树中，宗教\>=2的群体中，有57%的人经历了fistula。
-   通过决策树的结构可以看到哪些变量组合（如低财富+缺乏产后护理）与更高的fistula发生率相关。

### 4. **政策与干预建议**

-   这些决策树提供了潜在的干预点。例如，在Guinea-Bissau中，改善低财富和教育水平的女性的产后护理可能会减少fistula的发生。
-   不同国家的决策树展示了在不同社会和文化背景下，目标群体的主要风险因素，这对于制定具体的公共卫生政策非常重要。

### 5. **差异性与共性**

-   虽然不同国家的决策树表现出不同的变量组合，但共性因素如财富和教育的影响在多数国家中是显著的。
-   各国的文化、经济状况和社会结构的差异在这些决策树中得到了体现，这也反映了在不同环境下，fistula发生的复杂性。

总结来说，这些决策树揭示了在不同国家背景下影响女性经历fistula的关键因素。这些信息可以帮助制定更具针对性的干预措施，以降低fistula的发生率。

X Countries Random Forest

```{r}
# Cote d'lvoire
# Random Forest
data_model1 <- data1 %>% 
  filter(country == "Cote d'lvoire")

# 新建一个数据集，去掉 country 列
data_model1 <- data_model1 %>% select(-country)

# 检查 experienced_fistula 列
print(table(data_model1$experienced_fistula))

# 确保 experienced_fistula 是因子变量
data_model1$experienced_fistula <- as.factor(data_model1$experienced_fistula)

# 检查转换是否成功
str(data_model1$experienced_fistula)

# 使用 caret 包中的 downSample 函数进行下采样
set.seed(123)  # 设置随机种子以保证结果可重复
data_downsampled <-
  downSample(
    x = data_model1 %>% select(-experienced_fistula),
    y = data_model1$experienced_fistula,
    yname = "experienced_fistula"
  )

# 标准化权重
data_downsampled$V005 <- data_downsampled$V005 / 1000000  # 确保权重处理正确

# 下采样后的目标变量从1和2改为0和1
data_downsampled$experienced_fistula <- as.numeric(data_downsampled$experienced_fistula) - 1

# 确保除V005列都是因子类型
data_downsampled <- data_downsampled %>%
  mutate(across(-V005, as.factor))

# 确保 V005 是数值变量
data_downsampled$V005 <- as.numeric(data_downsampled$V005)

# 分割数据集为训练集和测试集
set.seed(123)
train_index <- createDataPartition(data_downsampled$experienced_fistula, p = 0.8, list = FALSE)
train_data <- data_downsampled[train_index, ]
test_data <- data_downsampled[-train_index, ]

# 设置训练控制，包含权重 交叉验证
train_control <- trainControl(method = "cv", number = 10)

set.seed(123)

# 设置参数调优范围
tune_grid <- expand.grid(mtry = c(1,3,5))

rf_model1 <- train(
  experienced_fistula ~ . - V005,
  data = train_data,
  method = "rf",
  trControl = train_control,
  weights = train_data$V005,
  tuneGrid = tune_grid,
  metric = "Accuracy",
  ntree = 200
)

# 查看随机森林模型结果
print(summary(rf_model1))

# 生成随机森林模型预测
rf_predictions1 <- predict(rf_model1, newdata = test_data)
rf_predictions1 <- factor(rf_predictions1, levels = levels(test_data$experienced_fistula))

# 计算随机森林模型混淆矩阵
rf_confusion_matrix1 <- confusionMatrix(rf_predictions1, test_data$experienced_fistula)
print(rf_confusion_matrix1)

# 提取特征重要性
importance_scores1 <- varImp(rf_model1, scale = FALSE)
print(importance_scores1)
```

```{r}
# 创建一个数据框
rf_results1 <- tibble(
  truth = test_data$experienced_fistula,
  estimate = rf_predictions1
)

# 计算精确率、召回率和F1分数
metrics1 <- metric_set(precision, recall, f_meas)

# 计算指标
results1 <- metrics1(rf_results1, truth = truth, estimate = estimate)
print(results1)


# -------------------------------------------------------------------
# ROC Curve
# 计算预测概率
rf_prob1 <- predict(rf_model1, newdata = test_data, type = "prob")[, 2]

# 计算ROC曲线
roc_curve1 <- roc(test_data$experienced_fistula, rf_prob1)

# 绘制ROC曲线
plot(roc_curve1, main = "Cote d'Ivoire:ROC Curve")

# 计算AUC
roc_auc1 <- auc(roc_curve1)
print(paste("Cote d'Ivoire-AUC for ROC:", roc_auc1))

# -------------------------------------------------------------------
# PR Curve
# 计算PR曲线
pr_curve1 <- pr.curve(scores.class0 = rf_prob1, weights.class0 = as.numeric(test_data$experienced_fistula) - 1, curve = TRUE)

# 绘制PR曲线
plot(pr_curve1, main = "Cote d'Ivoire:PR Curve")

# 计算AUC
pr_auc1 <- pr_curve1$auc.integral
print(paste("Cote d'Ivoire-AUC for PR Curve:", pr_auc1))
```

```{r}
# GuineaBissau
# Random Forest
data_model2 <- data1 %>% 
  filter(country == "GuineaBissau")

# 新建一个数据集，去掉 country 列
data_model2 <- data_model2 %>% select(-country)

# 确保 experienced_fistula 是因子变量
data_model2$experienced_fistula <- as.factor(data_model2$experienced_fistula)

# 检查转换是否成功
str(data_model2$experienced_fistula)

# 使用 caret 包中的 downSample 函数进行下采样
set.seed(123)  # 设置随机种子以保证结果可重复
data_downsampled <-
  downSample(
    x = data_model2 %>% select(-experienced_fistula),
    y = data_model2$experienced_fistula,
    yname = "experienced_fistula"
  )

# 标准化权重
data_downsampled$V005 <- data_downsampled$V005 / 1000000  # 确保权重处理正确

# 下采样后的目标变量从1和2改为0和1
data_downsampled$experienced_fistula <- as.numeric(data_downsampled$experienced_fistula) - 1

# 确保除V005列都是因子类型
data_downsampled <- data_downsampled %>%
  mutate(across(-V005, as.factor))

# 确保 V005 是数值变量
data_downsampled$V005 <- as.numeric(data_downsampled$V005)


# 分割数据集为训练集和测试集
set.seed(123)
train_index <- createDataPartition(data_downsampled$experienced_fistula, p = 0.8, list = FALSE)
train_data <- data_downsampled[train_index, ]
test_data <- data_downsampled[-train_index, ]

# 设置训练控制，包含权重 交叉验证
train_control <- trainControl(method = "cv", number = 10)

set.seed(123)

# 设置参数调优范围
tune_grid <- expand.grid(mtry = c(1,3,5))

rf_model2 <- train(
  experienced_fistula ~ . - V005,
  data = train_data,
  method = "rf",
  trControl = train_control,
  weights = train_data$V005,
  tuneGrid = tune_grid,
  metric = "Accuracy",
  ntree = 200
)

# 查看随机森林模型结果
print(summary(rf_model2))

# 生成随机森林模型预测
rf_predictions2 <- predict(rf_model2, newdata = test_data)
rf_predictions2 <- factor(rf_predictions2, levels = levels(test_data$experienced_fistula))

# 计算随机森林模型混淆矩阵
rf_confusion_matrix2 <- confusionMatrix(rf_predictions2, test_data$experienced_fistula)
print(rf_confusion_matrix2)

# 提取特征重要性
importance_scores2 <- varImp(rf_model2, scale = FALSE)
print(importance_scores2)

```

```{r}
# 创建一个数据框
rf_results2 <- tibble(
  truth = test_data$experienced_fistula,
  estimate = rf_predictions2
)

# 计算精确率、召回率和F1分数
metrics2 <- metric_set(precision, recall, f_meas)

# 计算指标
results2 <- metrics2(rf_results2, truth = truth, estimate = estimate)
print(results2)


# -------------------------------------------------------------------
# ROC Curve
# 计算预测概率
rf_prob2 <- predict(rf_model2, newdata = test_data, type = "prob")[, 2]

# 计算ROC曲线
roc_curve2 <- roc(test_data$experienced_fistula, rf_prob2)

# 绘制ROC曲线
plot(roc_curve2, main = "GuineaBissau:ROC Curve")

# 计算AUC
roc_auc2 <- auc(roc_curve2)
print(paste("GuineaBissau-AUC for ROC:", roc_auc2))

# -------------------------------------------------------------------
# PR Curve
# 计算PR曲线
pr_curve2 <- pr.curve(scores.class0 = rf_prob2, weights.class0 = as.numeric(test_data$experienced_fistula) - 1, curve = TRUE)

# 绘制PR曲线
plot(pr_curve2, main = "GuineaBissau:PR Curve")

# 计算AUC
pr_auc2 <- pr_curve2$auc.integral
print(paste("GuineaBissau-AUC for PR Curve:", pr_auc2))
```

```{r}
# Mali
# Random Forest
data_model3 <- data1 %>% 
  filter(country == "Mali")

# 新建一个数据集，去掉 country 列
data_model3 <- data_model3 %>% select(-country)

# 确保 experienced_fistula 是因子变量
data_model3$experienced_fistula <- as.factor(data_model3$experienced_fistula)

# 检查转换是否成功
str(data_model3$experienced_fistula)

# 使用 caret 包中的 downSample 函数进行下采样
set.seed(123)  # 设置随机种子以保证结果可重复
data_downsampled <-
  downSample(
    x = data_model3 %>% select(-experienced_fistula),
    y = data_model3$experienced_fistula,
    yname = "experienced_fistula"
  )

# 标准化权重
data_downsampled$V005 <- data_downsampled$V005 / 1000000  # 确保权重处理正确


# 下采样后的目标变量从1和2改为0和1
data_downsampled$experienced_fistula <- as.numeric(data_downsampled$experienced_fistula) - 1

# 确保除V005列都是因子类型
data_downsampled <- data_downsampled %>%
  mutate(across(-V005, as.factor))

# 确保 V005 是数值变量
data_downsampled$V005 <- as.numeric(data_downsampled$V005)


# 分割数据集为训练集和测试集
set.seed(123)
train_index <- createDataPartition(data_downsampled$experienced_fistula, p = 0.8, list = FALSE)
train_data <- data_downsampled[train_index, ]
test_data <- data_downsampled[-train_index, ]

# 设置训练控制，包含权重 交叉验证
train_control <- trainControl(method = "cv", number = 10)

set.seed(123)

# 设置参数调优范围
tune_grid <- expand.grid(mtry = c(1,3,5))

rf_model3 <- train(
  experienced_fistula ~ . - V005,
  data = train_data,
  method = "rf",
  trControl = train_control,
  weights = train_data$V005,
  tuneGrid = tune_grid,
  metric = "Accuracy",
  ntree = 100
)

# 查看随机森林模型结果
print(summary(rf_model3))

# 生成随机森林模型预测
rf_predictions3 <- predict(rf_model3, newdata = test_data)
rf_predictions3 <- factor(rf_predictions3, levels = levels(test_data$experienced_fistula))

# 计算随机森林模型混淆矩阵
rf_confusion_matrix3 <- confusionMatrix(rf_predictions3, test_data$experienced_fistula)
print(rf_confusion_matrix3)

# 提取特征重要性
importance_scores3 <- varImp(rf_model3, scale = FALSE)
print(importance_scores3)

```

```{r}
# 创建一个数据框
rf_results3 <- tibble(
  truth = test_data$experienced_fistula,
  estimate = rf_predictions3
)

# 计算精确率、召回率和F1分数
metrics3 <- metric_set(precision, recall, f_meas)

# 计算指标
results3 <- metrics3(rf_results3, truth = truth, estimate = estimate)
print(results3)


# -------------------------------------------------------------------
# ROC Curve
# 计算预测概率
rf_prob3 <- predict(rf_model3, newdata = test_data, type = "prob")[, 2]

# 计算ROC曲线
roc_curve3 <- roc(test_data$experienced_fistula, rf_prob3)

# 绘制ROC曲线
plot(roc_curve3, main = "Mali:ROC Curve")

# 计算AUC
roc_auc3 <- auc(roc_curve3)
print(paste("Mali-AUC for ROC:", roc_auc3))

# -------------------------------------------------------------------
# PR Curve
# 计算PR曲线
pr_curve3 <- pr.curve(scores.class0 = rf_prob3, weights.class0 = as.numeric(test_data$experienced_fistula) - 1, curve = TRUE)

# 绘制PR曲线
plot(pr_curve3, main = "Mali:PR Curve")

# 计算AUC
pr_auc3 <- pr_curve3$auc.integral
print(paste("Mali-AUC for PR Curve:", pr_auc3))
```

```{r}
# Nigeria
# Random Forest
data_model4 <- data1 %>% 
  filter(country == "Nigeria")

# 新建一个数据集，去掉 country 列
data_model4 <- data_model4 %>% select(-country)

# 确保 experienced_fistula 是因子变量
data_model4$experienced_fistula <- as.factor(data_model4$experienced_fistula)

# 检查转换是否成功
str(data_model4$experienced_fistula)

# 使用 caret 包中的 downSample 函数进行下采样
set.seed(123)  # 设置随机种子以保证结果可重复
data_downsampled <-
  downSample(
    x = data_model4 %>% select(-experienced_fistula),
    y = data_model4$experienced_fistula,
    yname = "experienced_fistula"
  )

# 标准化权重
data_downsampled$V005 <- data_downsampled$V005 / 1000000  # 确保权重处理正确


# 下采样后的目标变量从1和2改为0和1
data_downsampled$experienced_fistula <- as.numeric(data_downsampled$experienced_fistula) - 1

# 确保除V005列都是因子类型
data_downsampled <- data_downsampled %>%
  mutate(across(-V005, as.factor))

# 确保 V005 是数值变量
data_downsampled$V005 <- as.numeric(data_downsampled$V005)


# 分割数据集为训练集和测试集
set.seed(123)
train_index <- createDataPartition(data_downsampled$experienced_fistula, p = 0.8, list = FALSE)
train_data <- data_downsampled[train_index, ]
test_data <- data_downsampled[-train_index, ]

# 设置训练控制，包含权重 交叉验证
train_control <- trainControl(method = "cv", number = 10)

set.seed(123)

# 设置参数调优范围
tune_grid <- expand.grid(mtry = c(2,3,5))

rf_model4 <- train(
  experienced_fistula ~ . - V005,
  data = train_data,
  method = "rf",
  trControl = train_control,
  weights = train_data$V005,
  tuneGrid = tune_grid,
  metric = "Accuracy",
  ntree = 200
)

# 查看随机森林模型结果
print(summary(rf_model4))

# 生成随机森林模型预测
rf_predictions4 <- predict(rf_model4, newdata = test_data)
rf_predictions4 <- factor(rf_predictions4, levels = levels(test_data$experienced_fistula))

# 计算随机森林模型混淆矩阵
rf_confusion_matrix4 <- confusionMatrix(rf_predictions4, test_data$experienced_fistula)
print(rf_confusion_matrix4)

# 提取特征重要性
importance_scores4 <- varImp(rf_model4, scale = FALSE)
print(importance_scores4)

```

```{r}
# 创建一个数据框
rf_results4 <- tibble(
  truth = test_data$experienced_fistula,
  estimate = rf_predictions4
)

# 计算精确率、召回率和F1分数
metrics4 <- metric_set(precision, recall, f_meas)

# 计算指标
results4 <- metrics4(rf_results4, truth = truth, estimate = estimate)
print(results4)


# -------------------------------------------------------------------
# ROC Curve
# 计算预测概率
rf_prob4 <- predict(rf_model4, newdata = test_data, type = "prob")[, 2]

# 计算ROC曲线
roc_curve4 <- roc(test_data$experienced_fistula, rf_prob4)

# 绘制ROC曲线
plot(roc_curve4, main = "Nigeria:ROC Curve")

# 计算AUC
roc_auc4 <- auc(roc_curve4)
print(paste("Nigeria-AUC for ROC:", roc_auc4))

# -------------------------------------------------------------------
# PR Curve
# 计算PR曲线
pr_curve4 <- pr.curve(scores.class0 = rf_prob4, weights.class0 = as.numeric(test_data$experienced_fistula) - 1, curve = TRUE)

# 绘制PR曲线
plot(pr_curve4, main = "Nigeria:PR Curve")

# 计算AUC
pr_auc4 <- pr_curve4$auc.integral
print(paste("Nigeria-AUC for PR Curve:", pr_auc4))
```

```{r}
# SierraLeone
# Random Forest
data_model5 <- data1 %>% 
  filter(country == "SierraLeone")

# 新建一个数据集，去掉 country 列
data_model5 <- data_model5 %>% select(-country)

# 确保 experienced_fistula 是因子变量
data_model5$experienced_fistula <- as.factor(data_model5$experienced_fistula)

# 检查转换是否成功
str(data_model5$experienced_fistula)

# 使用 caret 包中的 downSample 函数进行下采样
set.seed(123)  # 设置随机种子以保证结果可重复
data_downsampled <-
  downSample(
    x = data_model5 %>% select(-experienced_fistula),
    y = data_model5$experienced_fistula,
    yname = "experienced_fistula"
  )

# 标准化权重
data_downsampled$V005 <- data_downsampled$V005 / 1000000  # 确保权重处理正确


# 下采样后的目标变量从1和2改为0和1
data_downsampled$experienced_fistula <- as.numeric(data_downsampled$experienced_fistula) - 1

# 确保除V005列都是因子类型
data_downsampled <- data_downsampled %>%
  mutate(across(-V005, as.factor))

# 确保 V005 是数值变量
data_downsampled$V005 <- as.numeric(data_downsampled$V005)


# 分割数据集为训练集和测试集
set.seed(123)
train_index <- createDataPartition(data_downsampled$experienced_fistula, p = 0.8, list = FALSE)
train_data <- data_downsampled[train_index, ]
test_data <- data_downsampled[-train_index, ]

# 设置训练控制，包含权重 交叉验证
train_control <- trainControl(method = "cv", number = 10)

set.seed(123)

# 设置参数调优范围
tune_grid <- expand.grid(mtry = c(1,3,5))

rf_model5 <- train(
  experienced_fistula ~ . - V005,
  data = train_data,
  method = "rf",
  trControl = train_control,
  weights = train_data$V005,
  tuneGrid = tune_grid,
  metric = "Accuracy",
  ntree = 200
)

# 查看随机森林模型结果
print(summary(rf_model5))

# 生成随机森林模型预测
rf_predictions5 <- predict(rf_model5, newdata = test_data)
rf_predictions5 <- factor(rf_predictions5, levels = levels(test_data$experienced_fistula))

# 计算随机森林模型混淆矩阵
rf_confusion_matrix5 <- confusionMatrix(rf_predictions5, test_data$experienced_fistula)
print(rf_confusion_matrix5)

# 提取特征重要性
importance_scores5 <- varImp(rf_model5, scale = FALSE)
print(importance_scores5)

```

```{r}
# 创建一个数据框
rf_results5 <- tibble(
  truth = test_data$experienced_fistula,
  estimate = rf_predictions5
)

# 计算精确率、召回率和F1分数
metrics5 <- metric_set(precision, recall, f_meas)

# 计算指标
results5 <- metrics5(rf_results5, truth = truth, estimate = estimate)
print(results5)


# -------------------------------------------------------------------
# ROC Curve
# 计算预测概率
rf_prob5 <- predict(rf_model5, newdata = test_data, type = "prob")[, 2]

# 计算ROC曲线
roc_curve5 <- roc(test_data$experienced_fistula, rf_prob5)

# 绘制ROC曲线
plot(roc_curve5, main = "SierraLeone:ROC Curve")

# 计算AUC
roc_auc5 <- auc(roc_curve5)
print(paste("SierraLeone-AUC for ROC:", roc_auc5))

# -------------------------------------------------------------------
# PR Curve
# 计算PR曲线
pr_curve5 <- pr.curve(scores.class0 = rf_prob5, weights.class0 = as.numeric(test_data$experienced_fistula) - 1, curve = TRUE)

# 绘制PR曲线
plot(pr_curve5, main = "SierraLeone:PR Curve")

# 计算AUC
pr_auc5 <- pr_curve5$auc.integral
print(paste("SierraLeone-AUC for PR Curve:", pr_auc5))
```

```{r}
# Togo
# Random Forest
data_model6 <- data1 %>% 
  filter(country == "Togo")

# 新建一个数据集，去掉 country 列
data_model6 <- data_model6 %>% select(-country)

# 确保 experienced_fistula 是因子变量
data_model6$experienced_fistula <- as.factor(data_model6$experienced_fistula)

# 检查转换是否成功
str(data_model6$experienced_fistula)

# 使用 caret 包中的 downSample 函数进行下采样
set.seed(123)  # 设置随机种子以保证结果可重复
data_downsampled <-
  downSample(
    x = data_model6 %>% select(-experienced_fistula),
    y = data_model6$experienced_fistula,
    yname = "experienced_fistula"
  )

# 标准化权重
data_downsampled$V005 <- data_downsampled$V005 / 1000000  # 确保权重处理正确


# 下采样后的目标变量从1和2改为0和1
data_downsampled$experienced_fistula <- as.numeric(data_downsampled$experienced_fistula) - 1

# 确保除V005列都是因子类型
data_downsampled <- data_downsampled %>%
  mutate(across(-V005, as.factor))

# 确保 V005 是数值变量
data_downsampled$V005 <- as.numeric(data_downsampled$V005)


# 分割数据集为训练集和测试集
set.seed(123)
train_index <- createDataPartition(data_downsampled$experienced_fistula, p = 0.8, list = FALSE)
train_data <- data_downsampled[train_index, ]
test_data <- data_downsampled[-train_index, ]

# 设置训练控制，包含权重 交叉验证
train_control <- trainControl(method = "cv", number = 10)

set.seed(123)

# 设置参数调优范围
tune_grid <- expand.grid(mtry = c(2,3,5))

rf_model6 <- train(
  experienced_fistula ~ . - V005,
  data = train_data,
  method = "rf",
  trControl = train_control,
  weights = train_data$V005,
  tuneGrid = tune_grid,
  metric = "Accuracy",
  ntree = 100
)

# 查看随机森林模型结果
print(summary(rf_model6))

# 生成随机森林模型预测
rf_predictions6 <- predict(rf_model6, newdata = test_data)
rf_predictions6 <- factor(rf_predictions6, levels = levels(test_data$experienced_fistula))

# 计算随机森林模型混淆矩阵
rf_confusion_matrix6 <- confusionMatrix(rf_predictions6, test_data$experienced_fistula)
print(rf_confusion_matrix6)

# 提取特征重要性
importance_scores6 <- varImp(rf_model6, scale = FALSE)
print(importance_scores6)

```

```{r}
# 创建一个数据框
rf_results6 <- tibble(
  truth = test_data$experienced_fistula,
  estimate = rf_predictions6
)

# 计算精确率、召回率和F1分数
metrics6 <- metric_set(precision, recall, f_meas)

# 计算指标
results6 <- metrics6(rf_results6, truth = truth, estimate = estimate)
print(results6)


# -------------------------------------------------------------------
# ROC Curve
# 计算预测概率
rf_prob6 <- predict(rf_model6, newdata = test_data, type = "prob")[, 2]

# 计算ROC曲线
roc_curve6 <- roc(test_data$experienced_fistula, rf_prob6)

# 绘制ROC曲线
plot(roc_curve6, main = "Togo:ROC Curve")

# 计算AUC
roc_auc6 <- auc(roc_curve6)
print(paste("Togo-AUC for ROC:", roc_auc6))

# -------------------------------------------------------------------
# PR Curve
# 计算PR曲线
pr_curve6 <- pr.curve(scores.class0 = rf_prob6, weights.class0 = as.numeric(test_data$experienced_fistula) - 1, curve = TRUE)

# 绘制PR曲线
plot(pr_curve6, main = "Togo:PR Curve")

# 计算AUC
pr_auc6 <- pr_curve6$auc.integral
print(paste("Togo-AUC for PR Curve:", pr_auc6))
```
